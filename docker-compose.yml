x-app-common: &app-common
  build:
    context: .
    dockerfile: docker/Dockerfile
  env_file: .env
  volumes:
    - .:/app
  networks:
    - crypto-network

services:
  postgres:
    image: postgres:15-alpine
    container_name: crypto-tracker-db
    env_file: .env
    ports: ["5432:5432"]
    volumes: [postgres_data:/var/lib/postgresql/data]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks: [crypto-network]

  redis:
    image: redis:7-alpine
    container_name: crypto-tracker-redis
    env_file: .env
    ports: ["6379:6379"]
    volumes: [redis_data:/data]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks: [crypto-network]

  app:
    <<: *app-common
    container_name: crypto-tracker-app
    ports: ["8000:8000"]
    entrypoint: ["/usr/local/bin/entrypoint.sh"]
    command: [python, -m, src.main]
    depends_on:
      postgres: { condition: service_healthy }
      redis: { condition: service_healthy }

  celery-worker:
    <<: *app-common
    container_name: crypto-tracker-celery-worker
    entrypoint: ["/usr/local/bin/entrypoint_celery.sh"]
    command: [celery, -A, src.celery_app, worker, -l, info]
    depends_on:
      postgres: { condition: service_healthy }
      redis: { condition: service_healthy }

  celery-beat:
    <<: *app-common
    container_name: crypto-tracker-celery-beat
    entrypoint: ["/usr/local/bin/entrypoint_celery.sh"]
    command: [celery, -A, src.celery_app, beat, -l, info]
    depends_on:
      postgres: { condition: service_healthy }
      redis: { condition: service_healthy }

volumes:
  postgres_data:
  redis_data:

networks:
  crypto-network:
    driver: bridge
