"""
Архитектура приложения Crypto Price Tracker

┌─────────────────────────────────────────────────────────────────────────┐
│                          ВНЕШНИЙ МИР                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌───────────────┐                    ┌───────────────────────────┐    │
│  │  Deribit API  │                    │     Клиенты (браузер)      │    │
│  │   (BTC/ETH)   │                    │     GET /api/v1/...        │    │
│  └───────┬───────┘                    └─────────────┬─────────────┘    │
│          │                                        │                    │
└──────────┼────────────────────────────────────────┼────────────────────┘
           │                                        │
           ▼                                        ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         СЛОЙ ПРИЛОЖЕНИЯ (API)                           │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                     FastAPI (app/main.py)                       │   │
│  │  ┌─────────────────────────────────────────────────────────┐   │   │
│  │  │                   Роутеры (routes.py)                   │   │   │
│  │  │  GET /prices          GET /prices/latest  GET /prices/  │   │   │
│  │  │  ?ticker=...          ?ticker=...         date-range    │   │   │
│  │  └─────────────────────────────────────────────────────────┘   │   │
│  │                    Dependency Injection                        │   │
│  │  ┌────────────────┐  ┌────────────────┐  ┌─────────────────┐   │   │
│  │  │  PriceService  │◄─┤  get_db()      │  │  get_settings() │   │   │
│  │  │  (Depends)     │  │  (AsyncSession)│  │  (Settings)     │   │   │
│  │  └────────────────┘  └────────────────┘  └─────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                      СЛОЙ БИЗНЕС-ЛОГИКИ (Services)                      │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │              app/services/price_service.py                      │   │
│  │  ┌─────────────────────────────────────────────────────────┐   │   │
│  │  │                   PriceService                          │   │   │
│  │  │  ┌─────────────────────────────────────────────────┐   │   │   │
│  │  │  │  fetch_and_save_all_prices()                    │   │   │   │
│  │  │  │  get_prices_by_ticker()                         │   │   │   │
│  │  │  │  get_latest_price()                             │   │   │   │
│  │  │  │  save_price_data()                              │   │   │   │
│  │  │  └─────────────────────────────────────────────────┘   │   │   │
│  │  │           │                   │                          │   │   │
│  │  │           ▼                   ▼                          │   │   │
│  │  │  ┌────────────────┐  ┌────────────────────────────┐    │   │   │
│  │  │  │  DeribitClient │  │      Database              │    │   │   │
│  │  │  │  (aiohttp)     │  │  (AsyncSession)            │    │   │   │
│  │  │  └────────────────┘  └────────────────────────────┘    │   │   │
│  │  └─────────────────────────────────────────────────────────┘   │   │
└─────────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                       СЛОЙ ДАННЫХ (Database)                            │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                     app/database.py                             │   │
│  │  ┌─────────────────────────────────────────────────────────┐   │   │
│  │  │                   Database                              │   │   │
│  │  │  ┌─────────────────────────────────────────────────┐   │   │   │
│  │  │  │  init()                                          │   │   │   │
│  │  │  │  get_session()  →  AsyncSession                 │   │   │   │
│  │  │  │  create_tables()                                │   │   │   │
│  │  │  │  close()                                        │   │   │   │
│  │  │  └─────────────────────────────────────────────────┘   │   │   │
│  │  └─────────────────────────────────────────────────────────┘   │   │
│  │                     app/models.py                               │   │
│  │  ┌─────────────────────────────────────────────────────────┐   │   │
│  │  │                   PriceRecord                           │   │   │
│  │  │  ┌─────────────────────────────────────────────────┐   │   │   │
│  │  │  │  id: int         ticker: str                    │   │   │   │
│  │  │  │  price: Decimal  timestamp: int  created_at: dt │   │   │   │
│  │  │  └─────────────────────────────────────────────────┘   │   │   │
│  │  └─────────────────────────────────────────────────────────┘   │   │
└─────────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         ХРАНИЛИЩЕ                                       │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    PostgreSQL                                   │   │
│  │  ┌─────────────────────────────────────────────────────────┐   │   │
│  │  │  Таблица: price_records                                 │   │   │
│  │  │  ┌─────────────────────────────────────────────────┐   │   │   │
│  │  │  │  id | ticker   | price      | timestamp | ...   │   │   │   │
│  │  │  │  1  | btc_usd  | 43250.50   | 1705000000 | ...   │   │   │   │
│  │  │  │  2  | eth_usd  | 2280.25    | 1705000000 | ...   │   │   │   │
│  │  │  └─────────────────────────────────────────────────┘   │   │   │
│  │  └─────────────────────────────────────────────────────────┘   │   │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                    ФОНОВЫЕ ЗАДАЧИ (Celery)                              │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    tasks/price_fetcher.py                       │   │
│  │  ┌─────────────────────────────────────────────────────────┐   │   │
│  │  │                   Celery Beat                            │   │   │
│  │  │  ┌─────────────────────────────────────────────────┐   │   │   │
│  │  │  │  fetch_all_prices()  -  каждые 60 секунд        │   │   │   │
│  │  │  │         │                                        │   │   │   │
│  │  │  │         ▼                                        │   │   │   │
│  │  │  │  ┌──────────────────────────────────────────┐   │   │   │
│  │  │  │  │  Celery Worker                           │   │   │   │
│  │  │  │  │  ┌──────────────────────────────────┐   │   │   │   │
│  │  │  │  │  │  DeribitClient.fetch_all_prices │   │   │   │   │
│  │  │  │  │  │  PriceService.fetch_and_save    │   │   │   │
│  │  │  │  │  │  Database.save()                │   │   │   │
│  │  │  │  │  └──────────────────────────────────┘   │   │   │
│  │  │  │  └──────────────────────────────────────────┘   │   │   │
│  │  │  └─────────────────────────────────────────────────┘   │   │
│  │  └─────────────────────────────────────────────────────────┘   │
│  │                    Redis (Broker)                               │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘

КЛЮЧЕВЫЕ ПРИНЦИПЫ:
─────────────────
1. Dependency Injection - все зависимости внедряются через конструкторы
2. Clean Architecture - разделение на слои (API → Services → Database)
3. Протоколы (Protocols) - для тестирования и мокинга
4. Async/Await - асинхронные операции с БД и HTTP
5. Фабрики - get_settings(), get_price_service(), get_database()
6. Нет глобальных переменных - состояние управляется явно
"""
